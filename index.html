
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produkty do kampaně — filtr & export XLSX</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg:#f7f9fc; --bg2:#eef3fb; --text:#1f2937; --muted:#6b7280;
      --card:#fff; --border:#e5e7eb; --primary:#1565c0; --accent:#0fb9b1; --warn:#dc2626;
      --radius:14px; --shadow:0 10px 24px rgba(31,41,55,.08);
    }
    html,body{height:100%;background:linear-gradient(160deg,var(--bg),var(--bg2));color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.6;margin:0}
    header{padding:20px 24px 8px}
    h1{margin:0;font-size:clamp(22px,3vw,28px)}
    .hint{color:var(--muted);font-size:13px;margin:6px 0 0}

    .grid{display:grid;grid-template-columns:1fr;gap:18px;padding:0 24px 24px}
    @media(min-width:1180px){.grid{grid-template-columns:420px 1fr}}
    .grid>*{min-width:0}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:16px;overflow:hidden}
    .card h2{margin:0 0 10px;font-size:clamp(18px,2.2vw,22px)}
    label{font-weight:600;display:block;margin-bottom:6px}
    input,select{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-accent{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-danger{background:var(--warn);color:#fff;border-color:var(--warn)}

    .status{font-size:13px;padding:8px 10px;border:1px dashed var(--border);border-radius:10px;background:rgba(0,0,0,.03);margin-top:8px}
    .error{color:var(--warn);margin-top:6px}
    .muted{color:var(--muted);font-size:13px}

    .progress{height:10px;background:#eef3fb;border-radius:6px;overflow:hidden;margin-top:8px}
    .progress>div{height:100%;width:0;background:#1565c0}

    table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:auto}
    thead th{background:#f8fafc;padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    tbody td{border-top:1px solid var(--border);padding:8px 10px}
    td.num{text-align:right}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef3fb;color:#111;font-size:12px;margin-left:6px}
    .kv{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .kv .item{background:#eef3fb;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Produkty do kampaně — filtr & export XLSX</h1>
    <p class="hint">
      Vstup 1 (long): <strong>Produkt</strong>, <strong>Dodavatel</strong>, <strong>Datum</strong>, <strong>Obrat</strong>.<br>
      Vstup 2 (systémový report): řádky 1–4 přeskočit, v <strong>A</strong> dodavatel (tučně) a pod ním produkty; v <strong>B</strong> obrat; <strong>ř. 5</strong> = datum (den pro všechny následující řádky).
    </p>
  </header>

  <div class="grid">
    <!-- OVLÁDACÍ PANEL -->
    <aside class="card">
      <h2>Nahrát & filtrovat</h2>

      <label for="file">Excel (.xls / .xlsx)</label>
      <input type="file" id="file" accept=".xlsx,.xls" onchange="introspectFile()" />

      <div class="controls-row">
        <div style="flex:1">
          <label for="sheetSel">List (sheet)</label>
          <select id="sheetSel"></select>
        </div>
        <div style="flex:1">
          <label for="dateFrom">Datum od</label>
          <input type="date" id="dateFrom" />
        </div>
        <div style="flex:1">
          <label for="dateTo">Datum do</label>
          <input type="date" id="dateTo" />
        </div>
      </div>

      <div class="controls-row">
        <div style="flex:1">
          <label for="minRevenue">Minimální obrat (Kč)</label>
          <input type="number" id="minRevenue" min="0" step="1" placeholder="např. 10000" />
        </div>
        <div style="flex:1">
          <label for="supplierFilter">Dodavatel (volitelné)</label>
          <input type="text" id="supplierFilter" placeholder="obsahuje…" />
        </div>
        <div style="flex:1">
          <label for="productFilter">Produkt (volitelné)</label>
          <input type="text" id="productFilter" placeholder="obsahuje…" />
        </div>
      </div>

      <div class="controls-row">
        <button class="btn btn-primary" onclick="filterAndExport()">Filtrovat & Exportovat XLSX</button>
        <button class="btn" onclick="previewFiltered()">Jen náhled</button>
        <button class="btn btn-danger" onclick="resetUI()">Reset</button>
      </div>

      <div id="status" class="status">Stav: připraveno (čekám na soubor)…</div>
      <div class="progress"><div id="progressBar"></div></div>
      <div id="error" class="error"></div>
      <div id="fileInfo" class="muted"></div>

      <h2 style="margin-top:14px">Detekované hlavičky</h2>
      <div id="headersBox" class="kv"></div>
    </aside>

    <!-- VÝSTUP / NÁHLED -->
    <main class="card">
      <h2>Náhled (prvních N záznamů po filtru)</h2>
      <div class="muted">Zobrazuje se jen ukázka (max. 200 řádků), aby UI bylo svižné.</div>
      <table id="previewTable">
        <thead>
          <tr>
            <th>Dodavatel</th><th>Produkt</th><th>Datum</th><th class="num">Obrat (Kč)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:14px">Souhrn</h2>
      <div id="summary" class="kv"></div>
    </main>
  </div>

  <!-- ===== Web Worker (Blob) — parsing XLSX, detekce módu, filtrování, export ===== -->
  <script>
    const workerCode = `
      /* ===== UTIL ===== */
      function norm(s){
        if (s == null) return '';
        s = String(s).trim().toLowerCase();
        const map = {'á':'a','č':'c','ď':'d','é':'e','ě':'e','í':'i','ň':'n','ó':'o','ř':'r','š':'s','ť':'t','ú':'u','ů':'u','ý':'y','ž':'z'};
        s = s.replace(/[áčďéěíňóřšťúůýž]/g, ch => map[ch] || ch);
        return s;
      }
      function matchHeader(h, keys){ const n = norm(h); return keys.some(k => n.indexOf(k)>=0); }
      function parseExcelDate(v){
        if (v == null) return null;
        if (v instanceof Date) return v;
        if (typeof v === 'number'){
          const d = new Date(Math.round((v - 25569) * 86400 * 1000));
          return isNaN(d.getTime()) ? null : d;
        }
        const d = new Date(String(v));
        return isNaN(d.getTime()) ? null : d;
      }
      function parseNum(val){
        if (typeof val === 'number') return val;
        if (val == null) return 0;
        const s = String(val).replace(/[^\d,.\- ]/g,'').replace(/\\s+/g,'').replace(/,/g,'.');
        const n = parseFloat(s); return isNaN(n) ? 0 : n;
      }
      function iso(d){ return d.toISOString().slice(0,10); }

      /* ===== SheetJS loader ===== */
      function loadXLSX(cb){
        function tryUrl(urls,i){
          if (i>=urls.length){ cb(new Error('XLSX se nepodařilo načíst')); return; }
          try{ importScripts(urls[i]); if (self.XLSX) cb(null); else tryUrl(urls,i+1); }
          catch(e){ tryUrl(urls,i+1); }
        }
        tryUrl([
          'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
          '/web/vendor/xlsx.full.min.js'
        ],0);
      }

      /* ===== Worker ===== */
      self.postMessage({type:'ready'});

      self.onmessage = function(ev){
        const msg = ev.data || {};
        if (msg.type === 'introspect'){
          loadXLSX(function(err){
            if (err){ self.postMessage({type:'error',message:err.message}); return; }
            try{
              const wb = XLSX.read(msg.arrayBuffer, { type:'array' });
              const sheetNames = wb.SheetNames.slice();
              const ws = wb.Sheets[sheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
              const headers = rows && rows.length ? (rows[0] || []) : [];
              self.postMessage({type:'introspected', sheetNames, headers});
            }catch(e){ self.postMessage({type:'error',message:e.message}); }
          });
        }

        if (msg.type === 'filter_export'){
          const ab = msg.arrayBuffer;
          const sheetName = msg.sheetName || null;
          const dateFrom = msg.dateFrom ? new Date(msg.dateFrom) : null;
          const dateTo   = msg.dateTo   ? new Date(msg.dateTo)   : null;
          const minRev   = typeof msg.minRevenue === 'number' ? msg.minRevenue : 0;
          const fSupp    = (msg.supplierContains || '').trim().toLowerCase();
          const fProd    = (msg.productContains  || '').trim().toLowerCase();
          const wantPreview = !!msg.wantPreview;

          loadXLSX(function(err){
            if (err){ self.postMessage({type:'error',message:err.message}); return; }

            try{
              const wb = XLSX.read(ab, { type:'array', cellDates:true, cellText:false, cellNF:false });
              const targetSheet = sheetName || wb.SheetNames[0];
              const ws = wb.Sheets[targetSheet];
              if (!ws){ self.postMessage({type:'error',message:'List (sheet) nebyl nalezen'}); return; }

              const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
              if (!rows || rows.length < 2){ self.postMessage({type:'error',message:'V listu nejsou data'}); return; }

              /* === Auto detekce módu ===
                 MODE_A (long): hlavičky obsahují Produkt/Dodavatel/Datum/Obrat
                 MODE_B (report): řádky 1–4 prázdné/hlaviční, ř.5 obsahuje datum a dál střídání A=Dodavatel (B prázdná) + produkty (A text, B číslo)
              */
              let mode = 'A';
              const headers = rows[0] || [];
              let idxProd=-1, idxSupp=-1, idxDate=-1, idxRev=-1;

              for (let c=0;c<headers.length;c++){
                const h = headers[c];
                if (idxProd<0 && matchHeader(h, ['produkt','product','nazev','sku','id produktu'])) idxProd=c;
                if (idxSupp<0 && matchHeader(h, ['dodavatel','supplier','vendor','seller','prodejce'])) idxSupp=c;
                if (idxDate<0 && matchHeader(h, ['datum','date','datum prodeje','sale date'])) idxDate=c;
                if (idxRev<0  && matchHeader(h, ['obrat','trzby','revenue','amount','castka','částka','sum'])) idxRev=c;
              }
              // Heuristika: když Datum/Obrat nejsou v hlavičce, zkus MODE_B
              if (idxDate<0 || idxRev<0){
                mode = 'B';
              }

              const out = [];    // [Dodavatel, Produkt, DatumISO, Obrat]
              const preview = [];
              let totalIn = 0, totalOut = 0;

              if (mode === 'A'){
                // fallback heuristika na idxDate/idxRev, když nejsou
                if (idxProd<0) idxProd = 0;
                if (idxSupp<0) idxSupp = 1;
                if (idxDate<0 || idxRev<0){
                  for (let c=0;c<headers.length;c++){
                    let dateScore=0, numScore=0;
                    for (let r=1;r<Math.min(rows.length,15);r++){
                      const v = rows[r][c];
                      const d = parseExcelDate(v);
                      const n = parseNum(v);
                      if (d && !isNaN(d.getTime())) dateScore++;
                      if (typeof v==='number' || (!isNaN(n) && String(v).match(/\\d/))) numScore++;
                    }
                    if (dateScore>=5 && idxDate<0) idxDate=c;
                    if (numScore >=5 && idxRev<0)  idxRev=c;
                  }
                }
                for (let r=1;r<rows.length;r++){
                  const row = rows[r]; if (!row) continue; totalIn++;
                  const prod = idxProd>=0 ? String(row[idxProd]||'').trim() : '';
                  const supp = idxSupp>=0 ? String(row[idxSupp]||'').trim() : '';
                  const dat  = parseExcelDate(row[idxDate]);
                  const rev  = parseNum(row[idxRev]);
                  if (!dat) continue;
                  if (dateFrom && dat<dateFrom) continue;
                  if (dateTo && dat>dateTo) continue;
                  if (rev < minRev) continue;
                  if (fSupp && !supp.toLowerCase().includes(fSupp)) continue;
                  if (fProd && !prod.toLowerCase().includes(fProd)) continue;

                  totalOut++;
                  const isoDate = iso(dat);
                  out.push([supp, prod, isoDate, rev]);
                  if (preview.length<200) preview.push({Dodavatel:supp,Produkt:prod,Datum:isoDate,Obrat:rev});
                  if (r%5000===0){ self.postMessage({type:'progress',value:Math.round(r/rows.length*100)}); }
                }
              } else {
                // MODE_B: systémový report (ř.5 = datum dne; A dodavatel header (B prázdná), pod tím produkty (A text, B číslo))
                const dateRowIdx = 4; // 0‑based: řádek 5
                let sheetDate = null;
                // najdi datum v řádku 5 (v libovolném sloupci)
                const row5 = rows[dateRowIdx] || [];
                for (let c=0;c<row5.length;c++){
                  const d = parseExcelDate(row5[c]);
                  if (d && !isNaN(d.getTime())) { sheetDate = d; break; }
                }
                // pokud datum chybí v řádku 5, zkus první řádek s platným datem do budoucna
                if (!sheetDate){
                  for (let r=0;r<Math.min(rows.length,10);r++){
                    for (let c=0;c<(rows[r]||[]).length;c++){
                      const d = parseExcelDate(rows[r][c]);
                      if (d && !isNaN(d.getTime())) { sheetDate = d; break; }
                    }
                    if (sheetDate) break;
                  }
                }
                if (!sheetDate){ self.postMessage({type:'error',message:'Nepodařilo se najít datum v řádku 5 ani v hlavičce.'}); return; }

                const startR = 5; // data začínají až pod řádkem 5 (tj. r>=5 → řádek 6)
                let currentSupplier = '';
                for (let r=startR;r<rows.length;r++){
                  const row = rows[r]; if (!row) continue; totalIn++;
                  const a = row[0]; // sloupec A
                  const b = row[1]; // sloupec B (obrat)
                  const aStr = (a==null?'':String(a).trim());
                  const rev = parseNum(b);

                  // Dodavatel header: A neprázdné + B prázdné
                  const isSupplierHeader = (aStr!=='' && (b==null || String(b).trim()===''));
                  // Produkt řádek: A neprázdné + B číslo
                  const isProductRow = (aStr!=='' && (typeof b==='number' || (!isNaN(parseNum(b)) && String(b).match(/\\d/))));

                  if (isSupplierHeader){
                    currentSupplier = aStr;
                  } else if (isProductRow){
                    const prod = aStr;
                    const dat = sheetDate; // všem řádkům je přiřazen datum z ř.5
                    if (dateFrom && dat<dateFrom) continue;
                    if (dateTo && dat>dateTo) continue;
                    if (rev < minRev) continue;
                    if (fSupp && !currentSupplier.toLowerCase().includes(fSupp)) continue;
                    if (fProd && !prod.toLowerCase().includes(fProd)) continue;

                    totalOut++;
                    const isoDate = iso(dat);
                    out.push([currentSupplier, prod, isoDate, rev]);
                    if (preview.length<200) preview.push({Dodavatel:currentSupplier,Produkt:prod,Datum:isoDate,Obrat:rev});
                  }

                  if (r%5000===0){ self.postMessage({type:'progress',value:Math.round(r/rows.length*100)}); }
                }
              }

              // Export XLSX (pořadí sloupců: Dodavatel, Produkt, Datum, Obrat)
              let xlsxBuffer = null, fileName = null;
              if (!wantPreview){
                const hdr = ['Dodavatel','Produkt','Datum','Obrat'];
                const aoa = [hdr].concat(out);
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                for (let r=1;r<=out.length;r++){
                  const addrDate = XLSX.utils.encode_cell({r, c:2}); // Datum
                  const addrRev  = XLSX.utils.encode_cell({r, c:3}); // Obrat
                  if (ws[addrDate]) ws[addrDate].z = 'yyyy-mm-dd';
                  if (ws[addrRev])  ws[addrRev].z  = '#,##0.00;[Red]-#,##0.00';
                }
                const wbOut = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wbOut, ws, 'Filtered');

                const arr = XLSX.write(wbOut, { bookType:'xlsx', type:'array' });
                xlsxBuffer = arr; // ArrayBuffer
                const df = dateFrom ? dateFrom.toISOString().slice(0,10) : 'od';
                const dt = dateTo   ? dateTo.toISOString().slice(0,10)   : 'do';
                fileName = 'Produkty_do_kampane__' + df + '_' + dt + '__min' + minRev + '.xlsx';
              }

              self.postMessage({
                type: wantPreview ? 'preview' : 'export',
                preview,
                summary: { totalIn, totalOut, sheetName: targetSheet, mode },
                xlsxBuffer,
                fileName,
                columns: { mode, idxProd, idxSupp, idxDate, idxRev, headers }
              });
            }catch(e){ self.postMessage({type:'error',message:e.message}); }
          });
        }
      };
    `;

    const workerBlob = new Blob([workerCode], { type:'application/javascript' });
    const workerURL  = URL.createObjectURL(workerBlob);
    const xlsxWorker = new Worker(workerURL);
  </script>

  <!-- ===== UI logika ===== -->
  <script>
    // DOM
    var fileEl      = document.getElementById('file');
    var sheetSelEl  = document.getElementById('sheetSel');
    var dateFromEl  = document.getElementById('dateFrom');
    var dateToEl    = document.getElementById('dateTo');
    var minRevenueEl= document.getElementById('minRevenue');
    var supplierEl  = document.getElementById('supplierFilter');
    var productEl   = document.getElementById('productFilter');
    var statusEl    = document.getElementById('status');
    var errorEl     = document.getElementById('error');
    var fileInfoEl  = document.getElementById('fileInfo');
    var progressBar = document.getElementById('progressBar');
    var headersBox  = document.getElementById('headersBox');
    var previewTBody= document.querySelector('#previewTable tbody');
    var summaryBox  = document.getElementById('summary');

    var lastArrayBuffer = null;

    // Worker zprávy
    xlsxWorker.onmessage = function(ev){
      var msg = ev.data || {};
      if (msg.type === 'ready'){
        statusEl.textContent = 'Stav: připraveno (čekám na soubor)…';
      }else if (msg.type === 'progress'){
        progressBar.style.width = msg.value + '%';
        statusEl.textContent = 'Stav: zpracovávám… ' + msg.value + '%';
      }else if (msg.type === 'error'){
        errorEl.textContent = 'Chyba: ' + msg.message;
        statusEl.textContent = 'Stav: chyba.';
      }else if (msg.type === 'introspected'){
        renderSheets(msg.sheetNames);
        renderHeaders(msg.headers);
        statusEl.textContent = 'Stav: soubor načten — vyber filtr a export.';
      }else if (msg.type === 'preview'){
        progressBar.style.width = '100%';
        statusEl.textContent = 'Stav: hotovo (náhled).';
        renderPreview(msg.preview);
        renderSummary(msg.summary);
      }else if (msg.type === 'export'){
        progressBar.style.width = '100%';
        statusEl.textContent = 'Stav: hotovo (export).';
        renderPreview(msg.preview); // ukázka
        renderSummary(msg.summary);
        triggerDownload(msg.xlsxBuffer, msg.fileName);
      }
    };

    function introspectFile(){
      clearMessages();
      var f = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
      if (!f){ statusEl.textContent = 'Stav: nejprve vyber soubor'; return; }
      fileInfoEl.textContent = 'Soubor: ' + f.name + ' (' + new Intl.NumberFormat('cs-CZ').format(f.size) + ' B)';
      statusEl.textContent = 'Stav: načítám soubor…';
      var reader = new FileReader();
      reader.onload = function(e){
        lastArrayBuffer = e.target.result;
        statusEl.textContent = 'Stav: detekce listů/hlaviček…';
        xlsxWorker.postMessage({ type:'introspect', arrayBuffer:lastArrayBuffer });
      };
      reader.onerror = function(){ errorEl.textContent = 'Chyba čtení souboru.'; statusEl.textContent = 'Stav: chyba.'; };
      reader.readAsArrayBuffer(f);
    }

    function filterAndExport(){
      if (!lastArrayBuffer){ statusEl.textContent='Stav: nahraj nejdřív soubor'; return; }
      clearMessages();
      progressBar.style.width = '0%';
      statusEl.textContent = 'Stav: zpracovávám & exportuji…';

      var payload = {
        type:'filter_export',
        arrayBuffer:lastArrayBuffer,
        sheetName: sheetSelEl.value || null,
        dateFrom:  dateFromEl.value || null,
        dateTo:    dateToEl.value   || null,
        minRevenue: parseFloat(minRevenueEl.value || '0') || 0,
        supplierContains: (supplierEl.value || ''),
        productContains:  (productEl.value  || ''),
        wantPreview: false
      };
      xlsxWorker.postMessage(payload);
    }

    function previewFiltered(){
      if (!lastArrayBuffer){ statusEl.textContent='Stav: nahraj nejdřív soubor'; return; }
      clearMessages();
      progressBar.style.width = '0%';
      statusEl.textContent = 'Stav: zpracovávám (náhled)…';

      var payload = {
        type:'filter_export',
        arrayBuffer:lastArrayBuffer,
        sheetName: sheetSelEl.value || null,
        dateFrom:  dateFromEl.value || null,
        dateTo:    dateToEl.value   || null,
        minRevenue: parseFloat(minRevenueEl.value || '0') || 0,
        supplierContains: (supplierEl.value || ''),
        productContains:  (productEl.value  || ''),
        wantPreview: true
      };
      xlsxWorker.postMessage(payload);
    }

    function triggerDownload(arrayBuffer, fileName){
      try{
        var blob = new Blob([arrayBuffer], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href=url; a.download = fileName || 'export.xlsx';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }catch(e){
        errorEl.textContent = 'Export se nezdařil: ' + e.message;
      }
    }

    function renderSheets(names){
      sheetSelEl.innerHTML = names.map(function(n){ return '<option value="'+escapeHtml(n)+'">'+escapeHtml(n)+'</option>'; }).join('');
    }
    function renderHeaders(headers){
      headersBox.innerHTML = (headers || []).map(function(h,i){
        var txt = (h==null || h==='') ? '(prázdné)' : escapeHtml(String(h));
        return '<div class="item">['+i+'] ' + txt + '</div>';
      }).join('');
    }
    function renderPreview(rows){
      var html = rows.map(function(r){
        return '<tr>' +
          '<td>' + escapeHtml(r.Dodavatel) + '</td>' +
          '<td>' + escapeHtml(r.Produkt) + '</td>' +
          '<td>' + escapeHtml(r.Datum) + '</td>' +
          '<td class="num">' + new Intl.NumberFormat('cs-CZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(r.Obrat) + '</td>' +
        '</tr>';
      }).join('');
      previewTBody.innerHTML = html;
    }
    function renderSummary(s){
      summaryBox.innerHTML = '' +
        '<div class="item">Řádků v listu: <strong>' + new Intl.NumberFormat('cs-CZ').format(s.totalIn) + '</strong></div>' +
        '<div class="item">Prošlo filtrem: <strong>' + new Intl.NumberFormat('cs-CZ').format(s.totalOut) + '</strong></div>' +
        '<div class="item">List: <strong>' + escapeHtml(s.sheetName) + '</strong></div>' +
        '<div class="item">Detekovaný mód: <strong>' + (s.mode==='A'?'long (hlavičky)':'report (ř.5=datum, A/B řádky)') + '</strong></div>';
    }

    function clearMessages(){ errorEl.textContent=''; statusEl.textContent='Stav: běžím…'; }
    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function resetUI(){
      fileEl.value = '';
      sheetSelEl.innerHTML = '';
      previewTBody.innerHTML = '';
      summaryBox.innerHTML = '';
      headersBox.innerHTML = '';
      errorEl.textContent = '';
      fileInfoEl.textContent = '';
      statusEl.textContent = 'Stav: připraveno (čekám na soubor)…';
      progressBar.style.width = '0%';
      lastArrayBuffer = null;
    }
  </script>
</body>
</html>
