
Jasně, rozumím. Udělám tyto úpravy:

1.  **Rozdělení tlačítek:** Místo jednoho tlačítka a "jen náhled" tam budou dvě hlavní: **"Filtrovat (Zobrazit)"** a **"Exportovat XLSX"**.
2.  **Logika tlačítek:**
    *   *Filtrovat* – spustí výpočet a aktualizuje tabulku na obrazovce (náhled).
    *   *Exportovat* – spustí stejný výpočet, ale rovnou nabídne soubor ke stažení.
3.  **Vynechání listu "Data":** Upravím skript tak, aby ignoroval list s názvem "Data".
4.  **Načítání více měsíců:** Upravím skript tak, aby projel **všechny listy** (kromě "Data") a sečetl data ze všech měsíců dohromady (agregace).

Zde je kompletně upravený kód `index.html`. Můžeš ho celý zkopírovat a přepsat jím ten původní na GitHubu.

```html
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produkty do kampaně — filtr & export XLSX</title>
  <style>
    /* ===== Design tokens ===== */
    :root{
      color-scheme: light dark;
      /* Světlé schéma */
      --bg1: #f6f9ff;
      --bg2: #eef3ff;
      --glass: rgba(255,255,255,0.65);
      --glass-border: rgba(17,24,39,0.08);
      --text: #0f172a;
      --muted: #64748b;
      --primary:#3b82f6; /* modrá */
      --primary-600:#2563eb;
      --primary-700:#1d4ed8;
      --accent:#10b981;  /* zelená */
      --accent-600:#059669;
      --warn:#ef4444;
      --tab-head:#f8fafc;
      --row-hover:#f1f5f9;
      --radius:16px;
      --radius-sm:12px;
      --shadow: 0 12px 40px rgba(2, 6, 23, .10);
      --shadow-soft: 0 6px 20px rgba(2, 6, 23, .08);
      --focus: 0 0 0 3px rgba(59,130,246,.35);
      --grad-1:#e0f2fe; /* cyan‑100 */
      --grad-2:#e9d5ff; /* purple‑100 */
      --progress:#2563eb;
      --card-stroke: rgba(30,41,59,.12);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg1: #0b1220;
        --bg2: #101626;
        --glass: rgba(17,24,39,0.55);
        --glass-border: rgba(148,163,184,0.18);
        --text: #e5e7eb;
        --muted: #94a3b8;
        --tab-head:#0f172a;
        --row-hover:#0b1220;
        --shadow: 0 14px 44px rgba(0,0,0,.45);
        --shadow-soft: 0 8px 26px rgba(0,0,0,.38);
        --grad-1:#0ea5e9; /* cyan‑500 */
        --grad-2:#8b5cf6; /* violet‑500 */
        --card-stroke: rgba(148,163,184,.18);
      }
    }
    /* ===== Base ===== */
    html,body{
      height:100%;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color: var(--text);
      line-height: 1.55;
      background:
        radial-gradient(1200px 1200px at 10% -10%, var(--grad-1) 0%, transparent 50%),
        radial-gradient(1200px 1200px at 110% 10%, var(--grad-2) 0%, transparent 50%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
    }
    * { box-sizing: border-box; }
    header{
      padding: 28px 24px 10px;
      max-width: 1240px;
      margin: 0 auto;
    }
    h1{
      margin:0;
      font-size: clamp(22px, 2.6vw, 32px);
      letter-spacing: -0.02em;
    }
    .hint{ color:var(--muted); font-size: 13px; margin: 8px 0 0; }
    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      padding: 0 24px 28px;
      max-width: 1240px;
      margin: 0 auto;
    }
    @media (min-width: 1180px){
      .grid{ grid-template-columns: 430px 1fr; }
    }
    .grid > * { min-width: 0; }
    /* Cards (glass) */
    .card{
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .card h2{ margin:0 0 12px; font-size: clamp(18px, 2.1vw, 22px); }
    /* Form */
    label{ font-weight: 600; display:block; margin-bottom: 6px; }
    input[type="file"],
    input[type="date"],
    input[type="number"],
    input[type="text"],
    select{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--card-stroke);
      background: rgba(255,255,255,.85);
      color: var(--text);
      outline: none;
      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    @media (prefers-color-scheme: dark){
      input[type="file"],
      input[type="date"],
      input[type="number"],
      input[type="text"],
      select{ background: rgba(15,23,42,.6); }
    }
    input:focus, select:focus{ box-shadow: var(--focus); border-color: var(--primary-600); }
    .controls-row{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 14px; border-radius: 12px;
      border: 1px solid var(--card-stroke);
      background: rgba(255,255,255,.9);
      color: var(--text);
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      font-weight: 600;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-soft); }
    .btn:active{ transform: translateY(0); }
    .btn-primary{ background: linear-gradient(180deg, var(--primary), var(--primary-600)); color: #fff; border-color: transparent; }
    .btn-primary:hover{ background: linear-gradient(180deg, var(--primary-600), var(--primary-700)); }
    .btn-accent{ background: linear-gradient(180deg, var(--accent), var(--accent-600)); color:#fff; border-color: transparent; }
    .btn-danger{ background: linear-gradient(180deg, #f87171, var(--warn)); color:#fff; border-color: transparent; }
    .status{
      font-size: 13px; padding:10px 12px;
      border:1px dashed var(--card-stroke);
      border-radius: 12px;
      background: rgba(2,6,23,.04);
      margin-top: 10px;
    }
    .error{ color: var(--warn); margin-top: 8px; }
    .muted{ color: var(--muted); font-size: 13px; }
    .progress{ height: 10px; border-radius: 999px; overflow: hidden; background: rgba(2,6,23,.06); margin-top: 10px; }
    .progress > div{ height:100%; width:0; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width .25s ease; }
    /* Table */
    table{ width:100%; border-collapse: collapse; margin-top: 12px; table-layout: auto; }
    thead th{
      background: var(--tab-head); padding: 10px 12px;
      border-bottom: 1px solid var(--card-stroke); text-align: left; font-weight: 700;
      position: sticky; top: 0; z-index: 1;
    }
    tbody td{ border-top: 1px solid var(--card-stroke); padding: 10px 12px; }
    tbody tr{ transition: background-color .15s ease; }
    tbody tr:hover{ background: var(--row-hover); }
    td.num{ text-align: right; }
    .kv{ display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    .kv .item{
      background: rgba(255,255,255,.5);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 8px 10px; font-size: 13px;
      backdrop-filter: blur(6px);
    }
    @media (prefers-color-scheme: dark){
      .kv .item{ background: rgba(15,23,42,.45); }
    }
    /* Micro-helpers */
    .pill{
      display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 700;
      background: rgba(59,130,246,.15); color: var(--primary-600);
    }
  </style>
</head>
<body>
  <header>
    <h1>Produkty do kampaně — filtr & export XLSX</h1>
    <p class="hint">
      Nástroj projde <strong>všechny listy</strong> v souboru (měsíce), ignoruje list "Data".<br>
      Agreguje <strong>Dodavatele</strong>, <strong>Produkty</strong> a sčítá <strong>Obraty</strong> napříč celým obdobím.
    </p>
  </header>
  <div class="grid">
    <!-- OVLÁDACÍ PANEL -->
    <aside class="card">
      <h2>Nahrát & filtrovat</h2>
      <label for="file">Excel (.xls / .xlsx)</label>
      <input type="file" id="file" accept=".xlsx,.xls" onchange="introspectFile()" />
      <div class="controls-row">
        <div style="flex:1">
          <label for="dateFrom">Datum od</label>
          <input type="date" id="dateFrom" />
        </div>
        <div style="flex:1">
          <label for="dateTo">Datum do</label>
          <input type="date" id="dateTo" />
        </div>
      </div>
      <div class="controls-row">
        <div style="flex:1">
          <label for="minRevenue">Minimální obrat (Kč)</label>
          <input type="number" id="minRevenue" min="0" step="1" placeholder="např. 10000" />
        </div>
        <div style="flex:1">
          <label for="supplierFilter">Dodavatel (volitelné)</label>
          <input type="text" id="supplierFilter" placeholder="obsahuje…" />
        </div>
        <div style="flex:1">
          <label for="productFilter">Produkt (volitelné)</label>
          <input type="text" id="productFilter" placeholder="obsahuje…" />
        </div>
      </div>
      
      <!-- TLAČÍTKA -->
      <div class="controls-row">
        <button class="btn btn-primary" onclick="runFilter()">Filtrovat (Náhled)</button>
        <button class="btn btn-accent" onclick="runExport()">Exportovat XLSX</button>
        <button class="btn btn-danger" onclick="resetUI()">Reset</button>
      </div>

      <div id="status" class="status">Stav: připraveno (čekám na soubor)…</div>
      <div class="progress"><div id="progressBar"></div></div>
      <div id="error" class="error"></div>
      <div id="fileInfo" class="muted"></div>
      
      <h2 style="margin-top:14px">Detekované listy</h2>
      <div id="headersBox" class="kv"></div>
    </aside>

    <!-- VÝSTUP / NÁHLED -->
    <main class="card">
      <h2>Náhled (Top 200 dle filtrů)</h2>
      <div class="muted">Data jsou agregována ze všech načtených listů (kromě "Data").</div>
      <table id="previewTable">
        <thead>
          <tr>
            <th>Dodavatel</th><th>Produkt</th><th class="num">Obrat (Kč)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h2 style="margin-top:14px">Souhrn zpracování</h2>
      <div id="summary" class="kv"></div>
    </main>
  </div>

  <!-- ===== Web Worker (Blob) ===== -->
  <script>
    const workerCode = `
      /* ===== UTIL ===== */
      function parseExcelDate(v){
        if (v == null) return null;
        if (v instanceof Date) return v;
        if (typeof v === 'number'){
          const d = new Date(Math.round((v - 25569) * 86400 * 1000));
          return isNaN(d.getTime()) ? null : d;
        }
        const d = new Date(String(v));
        return isNaN(d.getTime()) ? null : d;
      }
      function parseNum(val){
        if (typeof val === 'number') return val;
        if (val == null) return 0;
        const s = String(val).replace(/[^\\d,.\\- ]/g,'').replace(/\\s+/g,'').replace(/,/g,'.');
        const n = parseFloat(s); return isNaN(n) ? 0 : n;
      }
      function norm(s){ return String(s||'').toLowerCase().trim(); }
      function matchHeader(h, keys){ const n = norm(h); return keys.some(k => n.indexOf(k)>=0); }

      /* ===== SheetJS loader ===== */
      function loadXLSX(cb){
        function tryUrl(urls,i){
          if (i>=urls.length){ cb(new Error('Knihovnu XLSX se nepodařilo načíst')); return; }
          try{ importScripts(urls[i]); if (self.XLSX) cb(null); else tryUrl(urls,i+1); }
          catch(e){ tryUrl(urls,i+1); }
        }
        tryUrl([
          'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
        ],0);
      }

      /* ===== Worker Logic ===== */
      self.postMessage({type:'ready'});
      self.onmessage = function(ev){
        const msg = ev.data || {};
        
        // --- 1) Introspekce (zobrazit seznam listů)
        if (msg.type === 'introspect'){
          loadXLSX(function(err){
            if (err){ self.postMessage({type:'error',message:err.message}); return; }
            try{
              const wb = XLSX.read(msg.arrayBuffer, { type:'array', bookSheets:true });
              const allSheets = wb.SheetNames;
              // Vyfiltrujeme pro info uživateli, ale pošleme vše
              self.postMessage({type:'introspected', sheets: allSheets});
            }catch(e){ self.postMessage({type:'error',message:e.message}); }
          });
        }

        // --- 2) Filtr & Export (Iterace přes listy)
        if (msg.type === 'filter_export'){
          const ab = msg.arrayBuffer;
          const dateFrom = msg.dateFrom ? new Date(msg.dateFrom) : null;
          const dateTo   = msg.dateTo   ? new Date(msg.dateTo)   : null;
          const minRev   = typeof msg.minRevenue === 'number' ? msg.minRevenue : 0;
          const fSupp    = (msg.supplierContains || '').trim().toLowerCase();
          const fProd    = (msg.productContains  || '').trim().toLowerCase();
          const wantPreview = !!msg.wantPreview;

          loadXLSX(function(err){
            if (err){ self.postMessage({type:'error',message:err.message}); return; }
            try{
              // Načteme sešity
              const wb = XLSX.read(ab, { type:'array', cellDates:true, cellText:false, cellNF:false });
              
              // Definujeme, které listy chceme (všechny kromě "Data")
              const targetSheets = wb.SheetNames.filter(n => n.trim().toLowerCase() !== 'data');
              
              if (targetSheets.length === 0){
                self.postMessage({type:'error',message:'Nebyly nalezeny žádné datové listy (všechny odfiltrovány).'}); 
                return; 
              }

              // GLOBÁLNÍ AGREGÁTOR
              const agg = new Map(); // key = supp + '\u0001' + prod -> {supp, prod, sum, rows}
              let totalIn = 0;
              let totalAcceptedRows = 0;
              let processedSheets = 0;

              // Projdeme validní listy
              for (const sheetName of targetSheets) {
                processedSheets++;
                // Report progress
                const progressVal = Math.round((processedSheets / targetSheets.length) * 100);
                self.postMessage({type:'progress', value: progressVal, info: 'List: ' + sheetName});

                const ws = wb.Sheets[sheetName];
                if (!ws) continue;
                
                const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
                if (!rows || rows.length < 2) continue; // Prázdný list

                /* === Detekce módu pro tento konkrétní list === */
                // Zkusíme najít "Mode A" (long) nebo "Mode B" (report s hlavičkou v ř. 5)
                let mode = 'A';
                let idxProd=-1, idxSupp=-1, idxDate=-1, idxRev=-1;
                
                // Analýza prvního řádku pro Mode A
                const headers = rows[0] || [];
                for (let c=0;c<headers.length;c++){
                  const h = headers[c];
                  if (idxProd<0 && matchHeader(h, ['produkt','product','nazev','sku'])) idxProd=c;
                  if (idxSupp<0 && matchHeader(h, ['dodavatel','supplier','vendor','prodejce'])) idxSupp=c;
                  if (idxDate<0 && matchHeader(h, ['datum','date','prodeje'])) idxDate=c;
                  if (idxRev<0  && matchHeader(h, ['obrat','trzby','revenue','castka','částka','sum'])) idxRev=c;
                }

                // Pokud chybí datum nebo obrat v hlavičce, předpokládáme Mode B (Report)
                // U reportů bývá datum často v řádku 5 (index 4)
                if (idxDate<0 || idxRev<0){
                   mode = 'B';
                }

                if (mode === 'A'){
                  // Fallback indexy
                  if (idxProd<0) idxProd=0; if (idxSupp<0) idxSupp=1;
                  // Pokud stále chybí datum/obrat, zkusíme heuristiku (čísla/data ve sloupcích)
                  if (idxDate<0 || idxRev<0){
                     // zjednodušená heuristika
                     for(let c=0; c<headers.length; c++){
                       if (idxDate<0 && c!==idxProd && c!==idxSupp) idxDate=c; // "první volný je datum"
                       else if (idxRev<0 && c!==idxProd && c!==idxSupp && c!==idxDate) idxRev=c; 
                     }
                  }

                  for (let r=1; r<rows.length; r++){
                    const row = rows[r]; if (!row) continue; totalIn++;
                    const prod = idxProd>=0 ? String(row[idxProd]||'').trim() : '';
                    const supp = idxSupp>=0 ? String(row[idxSupp]||'').trim() : '';
                    const dat  = parseExcelDate(row[idxDate]);
                    const rev  = parseNum(row[idxRev]);

                    if (!dat) continue; // bez data ignorujeme
                    if (dateFrom && dat<dateFrom) continue;
                    if (dateTo && dat>dateTo) continue;
                    if (fSupp && !supp.toLowerCase().includes(fSupp)) continue;
                    if (fProd && !prod.toLowerCase().includes(fProd)) continue;

                    totalAcceptedRows++;
                    const key = supp + '\\u0001' + prod;
                    const curr = agg.get(key);
                    if (curr){ curr.sum += rev; curr.rows++; }
                    else { agg.set(key, {supp, prod, sum:rev, rows:1}); }
                  }
                } 
                else {
                  // === MODE B (Report) ===
                  // Hledáme datum listu (obvykle ř. 5 nebo hlavička)
                  let sheetDate = null;
                  const row5 = rows[4] || []; // řádek 5
                  for (let c=0; c<row5.length; c++){
                    const d = parseExcelDate(row5[c]);
                    if (d && !isNaN(d.getTime())) { sheetDate = d; break; }
                  }
                  // Pokud není v ř. 5, prohledáme prvních 10 řádků
                  if (!sheetDate){
                    for(let r=0; r<Math.min(rows.length,10); r++){
                      for(let c=0; c<(rows[r]||[]).length; c++){
                        const d = parseExcelDate(rows[r][c]);
                        if(d && !isNaN(d.getTime())) { sheetDate = d; break; }
                      }
                      if(sheetDate) break;
                    }
                  }
                  // Pokud stále nemáme datum, tento list přeskočíme
                  if (!sheetDate) continue; 

                  // Kontrola data listu vůči filtru
                  // (V reportech bývá jedno datum pro celý list, nebo jde o měsíční report)
                  const sheetDateObj = sheetDate;
                  
                  // Pokud je datum mimo rozsah, můžeme přeskočit celý list (pokud list reprezentuje jeden den)
                  // Ale pozor, pokud je to "Leden", datum může být 1.1., ale záznamy jsou za celý měsíc? 
                  // Z popisu uživatele: "ř. 5 = datum (den pro všechny řádky)". Tedy list = 1 den? 
                  // Uživatel ale říká "jsou tam měsíce". Možná každý list je jeden měsíc a datum je 1.dne?
                  // Pro jistotu: Filtrujeme podle tohoto data.
                  
                  let dateOk = true;
                  if (dateFrom && sheetDateObj < dateFrom) dateOk = false;
                  if (dateTo && sheetDateObj > dateTo) dateOk = false;
                  
                  // Pokud datum listu nevyhovuje, přeskočíme ho.
                  // (Pokud by list obsahoval víc dní, museli bychom iterovat řádky, ale struktura B implikuje 1 den/období)
                  if (!dateOk) continue; 

                  const startR = 5; // data začínají pod ř. 5
                  let currentSupplier = '';

                  for (let r=startR; r<rows.length; r++){
                    const row = rows[r]; if (!row) continue; totalIn++;
                    const a = row[0]; const b = row[1];
                    const aStr = (a==null?'':String(a).trim());
                    const rev = parseNum(b);

                    // Detekce: Dodavatel je v A, B je prázdné (nebo text)
                    // Detekce: Produkt je v A, B je číslo
                    
                    const isBEmpty = (b==null || String(b).trim()==='');
                    const isBNumber = (typeof b==='number' || (!isNaN(parseNum(b)) && String(b).match(/\\d/)));

                    if (aStr !== '' && isBEmpty){
                      currentSupplier = aStr;
                    } 
                    else if (aStr !== '' && isBNumber) {
                      // Je to produkt
                      const prod = aStr;
                      
                      // Filtry textové
                      if (fSupp && !currentSupplier.toLowerCase().includes(fSupp)) continue;
                      if (fProd && !prod.toLowerCase().includes(fProd)) continue;

                      totalAcceptedRows++;
                      const key = currentSupplier + '\\u0001' + prod;
                      const curr = agg.get(key);
                      if (curr){ curr.sum += rev; curr.rows++; }
                      else { agg.set(key, {supp:currentSupplier, prod, sum:rev, rows:1}); }
                    }
                  }
                }
              } // end for sheets

              // >>> Filtr minimálního obratu AŽ PO AGREGACI <<<
              let result = Array.from(agg.values());
              result = result.filter(x => x.sum >= minRev);
              
              // Seřadit podle obratu sestupně
              result.sort((a,b) => b.sum - a.sum);

              // Příprava dat pro export/náhled
              let xlsxBuffer = null, fileName = null;
              
              if (!wantPreview){
                const outArr = result.map(x => [x.supp, x.prod, x.sum]);
                const hdr = ['Dodavatel','Produkt','Obrat'];
                const aoa = [hdr].concat(outArr);
                
                const wsOut = XLSX.utils.aoa_to_sheet(aoa);
                // Formátování sloupce C (Obrat)
                for (let r=1; r<=outArr.length; r++){
                   const addr = XLSX.utils.encode_cell({r, c:2});
                   if(!wsOut[addr]) wsOut[addr]={t:'n',v:0};
                   wsOut[addr].z = '#,##0.00';
                }
                
                const wbOut = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wbOut, wsOut, 'Export');
                xlsxBuffer = XLSX.write(wbOut, { bookType:'xlsx', type:'array' });
                
                const dNow = new Date().toISOString().slice(0,10);
                fileName = 'Export_kampan_' + dNow + '.xlsx';
              }

              // Náhled (max 200 řádků)
              const preview = result.slice(0, 200).map(x => ({
                Dodavatel: x.supp, 
                Produkt: x.prod, 
                Obrat: x.sum
              }));

              self.postMessage({
                type: wantPreview ? 'preview' : 'export',
                preview,
                summary: { 
                  totalIn, 
                  totalOut: result.length, 
                  totalAcceptedRows, 
                  sheetCount: targetSheets.length 
                },
                xlsxBuffer,
                fileName
              });

            } catch(e){ 
              self.postMessage({type:'error',message:e.message}); 
            }
          });
        }
      };
    `;

    const workerBlob = new Blob([workerCode], { type:'application/javascript' });
    const workerURL  = URL.createObjectURL(workerBlob);
    const xlsxWorker = new Worker(workerURL);

    /* ===== UI LOGIKA ===== */
    var fileEl      = document.getElementById('file');
    var dateFromEl  = document.getElementById('dateFrom');
    var dateToEl    = document.getElementById('dateTo');
    var minRevenueEl= document.getElementById('minRevenue');
    var supplierEl  = document.getElementById('supplierFilter');
    var productEl   = document.getElementById('productFilter');
    var statusEl    = document.getElementById('status');
    var errorEl     = document.getElementById('error');
    var fileInfoEl  = document.getElementById('fileInfo');
    var progressBar = document.getElementById('progressBar');
    var headersBox  = document.getElementById('headersBox');
    var previewTBody= document.querySelector('#previewTable tbody');
    var summaryBox  = document.getElementById('summary');
    
    var lastArrayBuffer = null;

    // Přijímání zpráv od Workera
    xlsxWorker.onmessage = function(ev){
      var msg = ev.data || {};
      if (msg.type === 'ready'){
        statusEl.textContent = 'Stav: připraveno (čekám na soubor)…';
      }
      else if (msg.type === 'progress'){
        progressBar.style.width = msg.value + '%';
        statusEl.textContent = 'Stav: zpracovávám... ' + msg.info;
      }
      else if (msg.type === 'error'){
        errorEl.textContent = 'Chyba: ' + msg.message;
        statusEl.textContent = 'Stav: chyba.';
        progressBar.style.width = '0%';
      }
      else if (msg.type === 'introspected'){
        renderSheetsList(msg.sheets);
        statusEl.textContent = 'Stav: soubor načten. Vyber filtry a akci.';
      }
      else if (msg.type === 'preview'){
        progressBar.style.width = '100%';
        statusEl.textContent = 'Stav: hotovo (náhled aktualizován).';
        renderPreview(msg.preview);
        renderSummary(msg.summary);
      }
      else if (msg.type === 'export'){
        progressBar.style.width = '100%';
        statusEl.textContent = 'Stav: hotovo (stahování).';
        renderPreview(msg.preview);
        renderSummary(msg.summary);
        triggerDownload(msg.xlsxBuffer, msg.fileName);
      }
    };

    function introspectFile(){
      clearMessages();
      var f = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
      if (!f){ statusEl.textContent = 'Stav: nejprve vyber soubor'; return; }
      
      fileInfoEl.textContent = 'Soubor: ' + f.name + ' (' + (f.size/1024/1024).toFixed(2) + ' MB)';
      statusEl.textContent = 'Stav: načítám soubor…';
      
      var reader = new FileReader();
      reader.onload = function(e){
        lastArrayBuffer = e.target.result;
        statusEl.textContent = 'Stav: čtu seznam listů…';
        xlsxWorker.postMessage({ type:'introspect', arrayBuffer:lastArrayBuffer });
      };
      reader.onerror = function(){ errorEl.textContent = 'Chyba čtení souboru.'; };
      reader.readAsArrayBuffer(f);
    }

    function getPayload(wantPreview){
      return {
        type:'filter_export',
        arrayBuffer:lastArrayBuffer,
        dateFrom:  dateFromEl.value || null,
        dateTo:    dateToEl.value   || null,
        minRevenue: parseFloat(minRevenueEl.value || '0') || 0,
        supplierContains: (supplierEl.value || ''),
        productContains:  (productEl.value  || ''),
        wantPreview: wantPreview
      };
    }

    function runFilter(){
      if (!lastArrayBuffer){ statusEl.textContent='Stav: nahraj nejdřív soubor'; return; }
      clearMessages();
      progressBar.style.width = '0%';
      statusEl.textContent = 'Stav: počítám (náhled)…';
      xlsxWorker.postMessage(getPayload(true));
    }

    function runExport(){
      if (!lastArrayBuffer){ statusEl.textContent='Stav: nahraj nejdřív soubor'; return; }
      clearMessages();
      progressBar.style.width = '0%';
      statusEl.textContent = 'Stav: počítám a generuji XLSX…';
      xlsxWorker.postMessage(getPayload(false));
    }

    function triggerDownload(arrayBuffer, fileName){
      if(!arrayBuffer) return;
      try{
        var blob = new Blob([arrayBuffer], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href=url; a.download = fileName || 'export.xlsx';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }catch(e){
        errorEl.textContent = 'Stažení selhalo: ' + e.message;
      }
    }

    function renderSheetsList(sheets){
      if(!sheets) return;
      // Zobrazíme, které listy budou použity (ne Data)
      var html = sheets.map(function(s){
        var isData = (s.toLowerCase().trim() === 'data');
        var cls = isData ? 'item muted' : 'item';
        var txt = escapeHtml(s) + (isData ? ' (ignorováno)' : '');
        return '<div class="'+cls+'">'+txt+'</div>';
      }).join('');
      headersBox.innerHTML = html;
    }

    function renderPreview(rows){
      if(!rows || rows.length===0){
        previewTBody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px">Žádná data nevyhovují filtru</td></tr>';
        return;
      }
      var html = rows.map(function(r){
        return '<tr>' +
          '<td>' + escapeHtml(r.Dodavatel) + '</td>' +
          '<td>' + escapeHtml(r.Produkt) + '</td>' +
          '<td class="num">' + new Intl.NumberFormat('cs-CZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(r.Obrat) + '</td>' +
        '</tr>';
      }).join('');
      previewTBody.innerHTML = html;
    }

    function renderSummary(s){
      summaryBox.innerHTML = '' +
        '<div class="item">Zpracovaných listů: <strong>' + s.sheetCount + '</strong></div>' +
        '<div class="item">Nalezených položek (vstup): <strong>' + formatNum(s.totalIn) + '</strong></div>' +
        '<div class="item">Z toho validních (datum/filtr): <strong>' + formatNum(s.totalAcceptedRows) + '</strong></div>' +
        '<div class="item">Výsledných řádků (agregace): <strong>' + formatNum(s.totalOut) + '</strong></div>';
    }

    function clearMessages(){ errorEl.textContent=''; statusEl.textContent='Stav: běžím…'; }
    function formatNum(n){ return new Intl.NumberFormat('cs-CZ').format(n); }
    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function resetUI(){
      fileEl.value = '';
      previewTBody.innerHTML = '';
      summaryBox.innerHTML = '';
      headersBox.innerHTML = '';
      errorEl.textContent = '';
      fileInfoEl.textContent = '';
      statusEl.textContent = 'Stav: připraveno (čekám na soubor)…';
      progressBar.style.width = '0%';
      lastArrayBuffer = null;
      dateFromEl.value = '';
      dateToEl.value = '';
      minRevenueEl.value = '';
      supplierEl.value = '';
      productEl.value = '';
    }
  </script>
</body>
</html>
```
