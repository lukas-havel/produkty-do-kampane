<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produkty do kampaně — filtr & export XLSX</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">

  <style>
    :root{ --primary:#6366f1; --primary-dark:#4f46e5; --excel:#107C41; --bg-glass:rgba(255,255,255,0.85); --text-main:#1e293b; --text-muted:#64748b; }
    body { margin:0; font-family:'Segoe UI',system-ui,sans-serif; color:var(--text-main); height:100vh; background-color:#e0e7ff; background-image:radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); background-attachment:fixed; overflow-y:auto; }
    header { padding:30px 20px; max-width:1200px; margin:0 auto; color:white; text-shadow:0 2px 4px rgba(0,0,0,0.3); }
    h1 { margin:0; font-size:2rem; letter-spacing:-0.5px; }
    .hint { margin-top:8px; opacity:0.95; font-size:1.1rem; max-width:800px; font-weight:300; }
    
    .grid { display:grid; grid-template-columns:380px 1fr; gap:24px; max-width:1200px; margin:0 auto 40px; padding:0 20px; align-items:start; }
    @media (max-width:900px) { .grid { grid-template-columns:1fr; } }
    
    .card { background:var(--bg-glass); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.5); border-radius:16px; padding:24px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
    .card h2 { margin:0 0 12px; font-size:1.1rem; color:var(--primary-dark); text-transform:uppercase; letter-spacing:0.5px; }
    
    label { display:block; font-weight:600; margin-bottom:6px; font-size:0.85rem; color:var(--text-main); }
    input[type=file], input[type=text], input[type=number], select { width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; box-sizing:border-box; outline:none; transition:0.2s; font-size:0.9rem; }
    input:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,0.2); }
    input:disabled { background:#f1f5f9; cursor:not-allowed; opacity:0.7; }
    
    .controls-row { display:flex; gap:12px; margin-top:12px; } .controls-row > * { flex:1; }
    
    .btn { width:100%; padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; color:white; transition:0.2s; font-size:0.95rem; }
    .btn:hover { opacity:0.9; transform:scale(0.99); } .btn:disabled { opacity:0.5; transform:none; cursor:not-allowed; }
    .btn-primary { background:linear-gradient(135deg, var(--primary), var(--primary-dark)); }
    /* Excel Green Button */
    .btn-excel { background: var(--excel); }
    .btn-danger { background:#ef4444; width:auto; padding:6px 12px; font-size:0.8rem; }
    
    .status-box { margin-top:15px; padding:12px; background:rgba(255,255,255,0.5); border-radius:8px; font-size:0.85rem; border:1px dashed #cbd5e1; }
    
    /* Loading Bars */
    .progress-wrap { position:relative; height:12px; background:#e2e8f0; border-radius:99px; overflow:hidden; margin:8px 0; }
    .progress-bar { height:100%; width:0%; background:linear-gradient(90deg, var(--primary), var(--primary-dark)); transition:width 0.3s; }
    .progress-bar.upload { background:linear-gradient(90deg, #10b981, #059669); }
    .progress-bar.success { background:var(--excel); }
    
    .table-wrapper { overflow-x:auto; max-height:500px; border-radius:8px; border:1px solid #e2e8f0; margin-top:15px; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    thead th { background:#f8fafc; color:var(--text-muted); font-weight:700; padding:12px 16px; text-align:left; position:sticky; top:0; z-index:10; border-bottom:2px solid #e2e8f0; }
    tbody td { padding:10px 16px; border-bottom:1px solid #f1f5f9; background:#fff; }
    th.num, td.num { text-align:right; }
    
    .summary { display:flex; gap:10px; flex-wrap:wrap; margin-top:15px; }
    .tag { background:rgba(99,102,241,0.1); color:var(--primary-dark); padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; border:1px solid rgba(99,102,241,0.2); }
    
    /* Sekce bez mezery */
    .section-gap { margin-top:20px; }
  </style>
</head>
<body>

<header>
  <h1>Produkty do kampaně</h1>
  <p class="hint">Komplexní nástroj pro načtení, filtraci a export produktových dat z Excelu.</p>
</header>

<div class="grid">
  <aside class="card">
    <h2>1. Nahrát soubor</h2>
    
    <label class="btn btn-primary" style="text-align:center; display:block; width:auto">
      Vybrat Excel (.xls / .xlsx / .xlsb)
      <input type="file" id="file" accept=".xlsx,.xls,.xlsb" style="display:none" onclick="resetUI(false)" onchange="handleFileSelect()" />
    </label>
    
    <!-- Upload Bar POD tlačítkem -->
    <div class="progress-wrap"><div id="barUpload" class="progress-bar upload"></div></div>
    <div id="fileInfo" class="muted" style="text-align:center; font-size:0.8rem; min-height:18px;"></div>

    <!-- Žádná čára, jen menší mezera -->
    <div class="section-gap"></div>

    <h2>2. Filtrovat data</h2>
    <div class="controls-row">
      <div><label>Datum od</label><input type="text" id="dateFrom" placeholder="Vyberte..." disabled /></div>
      <div><label>Datum do</label><input type="text" id="dateTo" placeholder="Vyberte..." disabled /></div>
    </div>
    
    <div style="margin-top:12px">
      <label>Dodavatel (obsahuje text)</label>
      <input type="text" id="supplierInput" placeholder="Např. Alza..." disabled>
    </div>
    
    <div style="margin-top:12px">
      <label>Minimální obrat (Kč)</label>
      <input type="number" id="minRevenue" min="0" step="1000" placeholder="10000" disabled />
    </div>
    
    <div class="section-gap"></div>

    <div class="controls-row">
      <button class="btn btn-primary" id="btnPreview" onclick="runFilter()" disabled>Zobrazit náhled</button>
      <button class="btn btn-excel" id="btnExport" onclick="runExport()" disabled>Stáhnout XLSX</button>
    </div>
    
    <div style="margin-top:10px; text-align:right;">
      <button class="btn btn-danger" onclick="resetUI(true)">Reset</button>
    </div>
    
    <div class="status-box">
      <div id="status" style="font-weight:600">Čekám na akci...</div>
      <div class="progress-wrap" id="processWrap" style="opacity:0.5; margin-bottom:0">
        <div id="barProcess" class="progress-bar"></div>
      </div>
      <div id="processTxt" style="text-align:center; font-size:0.75rem; margin-top:4px;">0%</div>
      <div id="error" style="color:#dc2626; margin-top:8px; font-weight:600;"></div>
    </div>
  </aside>

  <main class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Výsledky</h2><div class="muted" style="font-size:0.85rem">TOP 50</div>
    </div>
    <div class="table-wrapper">
      <table id="previewTable">
        <thead><tr><th>Dodavatel</th><th>Produkt</th><th class="num">Obrat (Kč)</th></tr></thead>
        <tbody><tr><td colspan="3" style="text-align:center; padding:30px; color:#94a3b8">Zatím žádná data</td></tr></tbody>
      </table>
    </div>
    <div id="summary" class="summary"></div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/cs.js"></script>

<script>

  
const workerCode = `
  function norm(s){ return String(s||'').toLowerCase().trim(); }
  function parseNum(val){
    if(typeof val==='number') return val; if(val==null) return 0;
    let s=String(val).replace(/\\s/g,'').replace(/\\u00a0/g,'').replace(/kč/i,'').replace(',','.'); 
    s=s.replace(/[^0-9.-]/g,''); const n=parseFloat(s); return isNaN(n)?0:n;
  }
  function parseHeaderDate(v){
    if(v instanceof Date) return v;
    if(typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return isNaN(d.getTime())?null:d; }
    if(typeof v==='string'){
       const parts=v.split('.'); 
       if(parts.length===3){ const d=new Date(parts[2],parts[1]-1,parts[0]); if(!isNaN(d.getTime())) return d; }
       const d2=new Date(v); if(!isNaN(d2.getTime())) return d2;
    }
    return null;
  }
  function getSheetDateRange(name, filterYear){
    const n = norm(name);
    const czMonths = ['leden','unor','brezen','duben','kveten','cerven','cervenec','srpen','zari','rijen','listopad','prosinec'];
    const simpleMonths = ['leden','únor','březen','duben','květen','červen','červenec','srpen','září','říjen','listopad','prosinec'];
    let monthIdx = -1;
    for(let i=0; i<12; i++){ if(n.includes(czMonths[i]) || n.includes(simpleMonths[i])) { monthIdx = i; break; } }
    if(monthIdx === -1) return null;
    let year = filterYear || new Date().getFullYear();
    const yearMatch = name.match(/20\\d{2}/);
    if(yearMatch) year = parseInt(yearMatch[0], 10);
    const start = new Date(year, monthIdx, 1);
    const end = new Date(year, monthIdx + 1, 0, 23, 59, 59);
    return { start, end };
  }

  function loadXLSX(cb){ try{ importScripts('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'); cb(); }catch(e){ cb(e); } }

  self.onmessage = function(ev){
    const msg = ev.data || {};
    if(msg.type === 'process'){
      const { arrayBuffer, supplierFilter, minRevenue, wantPreview } = msg;
      const dateFrom = msg.dateFrom ? new Date(msg.dateFrom) : null;
      if(dateFrom) dateFrom.setHours(0,0,0,0);
      const dateTo = msg.dateTo ? new Date(msg.dateTo) : null;
      if(dateTo) dateTo.setHours(23,59,59,999);
      const fallbackYear = dateFrom ? dateFrom.getFullYear() : (dateTo ? dateTo.getFullYear() : new Date().getFullYear());

      loadXLSX(function(err){
        if(err){ self.postMessage({type:'error', message:'Chyba knihovny'}); return; }
        try {
          self.postMessage({type:'status', info:'Vybírám listy...'});
          const wbMeta = XLSX.read(arrayBuffer, { type:'array', bookSheets:true });
          const sheetsToProcess = [];

          for(const shName of wbMeta.SheetNames){
            if(shName.toLowerCase() === 'data') continue;
            if(dateFrom || dateTo){
              const range = getSheetDateRange(shName, fallbackYear);
              if(!range) continue;
              if(dateFrom && range.end < dateFrom) continue;
              if(dateTo && range.start > dateTo) continue;
            }
            sheetsToProcess.push(shName);
          }

          if(sheetsToProcess.length === 0){
            self.postMessage({type:'error', message:'Žádné listy neodpovídají zvolenému období.'});
            return;
          }

          self.postMessage({type:'status', info:'Načítám data ('+sheetsToProcess.length+' listů)...'});
          const wb = XLSX.read(arrayBuffer, { type:'array', cellDates:true, cellStyles:false, sheets: sheetsToProcess });
          
          const agg = new Map();
          let totalIn = 0;
          let processedCount = 0;
          const filterSuppLower = supplierFilter ? supplierFilter.toLowerCase().trim() : null;

          for(const shName of sheetsToProcess){
            processedCount++;
            self.postMessage({ type:'progress', value: Math.round((processedCount/sheetsToProcess.length)*100), info:'Analyzuji: ' + shName });

            const ws = wb.Sheets[shName];
            const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
            if(!rows || rows.length < 2) continue;

            const header = rows[0];
            const validCols = [];
            for(let c=2; c<header.length; c++){ 
              const d = parseHeaderDate(header[c]);
              if(d){
                let ok = true;
                if(dateFrom && d < dateFrom) ok = false;
                if(dateTo && d > dateTo) ok = false;
                if(ok) validCols.push(c);
              }
            }
            if(validCols.length === 0 && (dateFrom || dateTo)) continue;

            let currSupp = null;
            for(let r=1; r<rows.length; r++){
              const row = rows[r]; if(!row) continue;
              const valA = row[0]; const valB = row[1];

              if(valA && String(valA).trim()){
                const s = String(valA).trim();
                if(s.toLowerCase()!=='dodavatel' && s.toLowerCase()!=='supplier') currSupp = s;
              }

              if(valB && currSupp){
                const prod = String(valB).trim();
                if(prod.toUpperCase().startsWith('SL')) continue;
                if(prod.toLowerCase()==='produkt') continue;
                if(filterSuppLower && !currSupp.toLowerCase().includes(filterSuppLower)) continue;

                let sum = 0;
                for(let c of validCols){
                  const v = row[c]; if(v) sum += parseNum(v);
                }

                if(sum !== 0){
                  totalIn++;
                  const key = currSupp + '|||' + prod;
                  const exist = agg.get(key);
                  if(exist) exist.sum += sum; else agg.set(key, { s:currSupp, p:prod, sum:sum });
                }
              }
            }
          }

          let res = Array.from(agg.values());
          if(minRevenue > 0) res = res.filter(x => x.sum >= minRevenue);
          res.sort((a,b) => b.sum - a.sum);

          let xlsxBuff = null, fName = null;
          if(!wantPreview){
            const aoa = [['Dodavatel','Produkt','Obrat']].concat(res.map(x => [x.s, x.p, x.sum]));
            const newWs = XLSX.utils.aoa_to_sheet(aoa);
            for(let r=1; r<aoa.length; r++){
               const ref = XLSX.utils.encode_cell({r:r, c:2});
               if(newWs[ref]) newWs[ref].z = '#,##0.00';
            }
            const newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newWs, 'Export');
            xlsxBuff = XLSX.write(newWb, { bookType:'xlsx', type:'array' });
            fName = 'Export_kampan.xlsx';
          }

          self.postMessage({
            type: wantPreview ? 'preview' : 'export',
            data: res.slice(0, 50),
            stats: { totalIn, out: res.length, sheetCount: sheetsToProcess.length },
            file: { buff: xlsxBuff, name: fName }
          });

        } catch(e){ self.postMessage({type:'error', message:e.message}); }
      });
    }
  };
`;

const blob = new Blob([workerCode], {type:'application/javascript'});
const worker = new Worker(URL.createObjectURL(blob));

const el = id => document.getElementById(id);
let lastBuffer = null;

window.onload = function() {
  const cfg = { locale: "cs", dateFormat: "Y-m-d", altInput: true, altFormat: "j. F Y", allowInput: true };
  flatpickr("#dateFrom", cfg);
  flatpickr("#dateTo", cfg);
};

worker.onmessage = e => {
  const m = e.data;
  if(m.type === 'error'){ el('error').textContent = m.message; el('status').textContent = 'Chyba.'; setProcess(0,'error'); }
  else if(m.type === 'status'){ el('status').textContent = m.info; }
  else if(m.type === 'progress'){ setProcess(m.value); el('status').textContent = m.info; }
  else if(m.type === 'preview' || m.type === 'export'){
    setProcess(100,'success'); el('status').textContent = 'Hotovo.';
    renderTable(m.data);
    el('summary').innerHTML = '<div class="tag">Vybráno listů: '+m.stats.sheetCount+'</div><div class="tag">Položek: '+fmt(m.stats.totalIn)+'</div><div class="tag">Výsledek: '+fmt(m.stats.out)+'</div>';
    if(m.type === 'export') download(m.file.buff, m.file.name);
  }
};

function handleFileSelect(){
  const f = el('file').files[0]; if(!f) return;
  resetUI(false); 
  el('fileInfo').textContent = f.name + ' (' + (f.size/1024/1024).toFixed(1) + ' MB)';
  el('status').textContent = 'Nahrávám...';
  const reader = new FileReader();
  reader.onprogress = e => { if(e.lengthComputable) setUpload((e.loaded/e.total)*100); };
  reader.onload = e => {
    lastBuffer = e.target.result;
    setUpload(100); el('status').textContent = 'Připraveno.';
    document.querySelectorAll('input, button').forEach(i => i.disabled = false);
  };
  reader.readAsArrayBuffer(f);
}

function runFilter(){ start(true); }
function runExport(){ start(false); }
function start(preview){
  if(!lastBuffer) return;
  el('error').textContent = '';
  setProcess(1); el('status').textContent = 'Start...';
  worker.postMessage({
    type: 'process', arrayBuffer: lastBuffer, wantPreview: preview,
    dateFrom: el('dateFrom').value, dateTo: el('dateTo').value,
    minRevenue: parseFloat(el('minRevenue').value || 0),
    supplierFilter: el('supplierInput').value
  });
}

function renderTable(data){
  const tbody = el('previewTable').getElementsByTagName('tbody')[0];
  if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:30px">Žádná data</td></tr>'; return; }
  let html = '';
  data.forEach(r => { html += '<tr><td>'+esc(r.s)+'</td><td>'+esc(r.p)+'</td><td class="num">'+fmtMoney(r.sum)+'</td></tr>'; });
  tbody.innerHTML = html;
}

function download(buff, name){
  const url = URL.createObjectURL(new Blob([buff], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  const a = document.createElement('a'); a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function setUpload(p){ el('barUpload').style.width=p+'%'; }
function setProcess(p,s){ 
  const b=el('barProcess'); b.style.width=p+'%'; 
  el('processTxt').textContent=Math.round(p)+'%';
  if(s==='success') b.classList.add('success'); else b.classList.remove('success'); 
}
function resetUI(full){
  if(full){ el('file').value=''; lastBuffer=null; setUpload(0); el('fileInfo').textContent=''; document.querySelectorAll('input:not(#file), button:not(#btnFile)').forEach(i=>i.disabled=true); document.querySelector('.btn-danger').disabled=false; }
  el('previewTable').getElementsByTagName('tbody')[0].innerHTML='<tr><td colspan="3" style="text-align:center;padding:30px">Zatím žádná data</td></tr>'; el('summary').innerHTML=''; el('error').textContent=''; el('status').textContent='Stav: připraveno'; el('processWrap').style.opacity='0.5'; el('barProcess').style.width='0%'; el('processTxt').textContent='0%';
}
function fmt(n){ return new Intl.NumberFormat('cs-CZ').format(n); }
function fmtMoney(n){ return new Intl.NumberFormat('cs-CZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
</script>
</body>
</html>
