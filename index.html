<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produkty do kampaně — filtr & export XLSX</title>
  <style>
    /* ===== Design tokens & Theme ===== */
    :root{
      --primary: #6366f1; /* Indigo */
      --primary-dark: #4f46e5;
      --accent: #ec4899;  /* Pink */
      --success: #10b981; /* Emerald */
      --bg-glass: rgba(255, 255, 255, 0.85);
      --border-glass: rgba(255, 255, 255, 0.5);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --radius: 16px;
    }

    /* ===== Base & Background ===== */
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--text-main);
      height: 100vh;
      /* Moderní barevné pozadí */
      background-color: #e0e7ff;
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-attachment: fixed;
      overflow-y: auto; /* Povolit scroll celé stránky */
    }

    header {
      padding: 30px 20px;
      max-width: 1200px;
      margin: 0 auto;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    h1 { margin: 0; font-size: 2rem; letter-spacing: -0.5px; }
    .hint { margin-top: 8px; opacity: 0.9; font-size: 0.95rem; max-width: 600px; line-height: 1.5; }

    /* ===== Layout ===== */
    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto 40px;
      padding: 0 20px;
      align-items: start;
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    /* ===== Glass Card ===== */
    .card {
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .card h2 { margin: 0 0 16px; font-size: 1.2rem; color: var(--primary-dark); }

    /* ===== Forms ===== */
    label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
    input[type="file"], input[type="date"], input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #fff;
      font-family: inherit;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
    
    .controls-row { display: flex; gap: 12px; margin-top: 12px; }
    .controls-row > * { flex: 1; }

    /* ===== Buttons ===== */
    .btn {
      width: 100%; padding: 12px; border: none; border-radius: 10px;
      font-weight: 600; cursor: pointer; color: white;
      transition: transform 0.1s, opacity 0.2s;
      font-size: 0.95rem;
    }
    .btn:active { transform: scale(0.98); }
    .btn:hover { opacity: 0.9; }
    
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
    .btn-accent { background: linear-gradient(135deg, var(--accent), #db2777); }
    .btn-danger { background: #ef4444; color: white; width: auto; padding: 12px 16px; }

    /* ===== Status & Progress ===== */
    .status-box { margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px; font-size: 0.9rem; border: 1px dashed #cbd5e1; }
    .error { color: #dc2626; margin-top: 8px; font-weight: 600; }
    .muted { color: var(--text-muted); font-size: 0.85rem; margin-top: 4px; }

    .progress-wrap { position: relative; height: 16px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin: 8px 0 16px; }
    .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s ease, background 0.3s; }
    .progress-bar.success { background: var(--success); } /* Zelená po dokončení */
    .progress-txt { position: absolute; width: 100%; text-align: center; top: 0; line-height: 16px; font-size: 10px; font-weight: bold; color: rgba(0,0,0,0.6); }

    /* ===== Table ===== */
    .table-wrapper { overflow-x: auto; max-height: 500px; border-radius: 8px; border: 1px solid #e2e8f0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    
    /* Sticky Header */
    thead th {
      background: #f8fafc;
      color: var(--text-muted);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      padding: 12px 16px;
      text-align: left;
      position: sticky; 
      top: 0; 
      z-index: 10;
      border-bottom: 2px solid #e2e8f0;
    }
    
    tbody td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; background: #fff; }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: #f8fafc; }
    
    /* Zarovnání čísel */
    th.num, td.num { text-align: right; font-feature-settings: "tnum"; }

    /* Summary Stats */
    .summary { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    .tag { background: rgba(99, 102, 241, 0.1); color: var(--primary-dark); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(99, 102, 241, 0.2); }
  </style>
</head>
<body>

<header>
  <h1>Produkty do kampaně</h1>
  <p class="hint">
    Inteligentní filtr a export. Ignoruje produkty začínající na "SL".<br>
    Podporuje filtraci podle data (sloupců) a výběr dodavatele.
  </p>
</header>

<div class="grid">
  <!-- SIDEBAR: Ovládání -->
  <aside class="card">
    <h2>1. Nahrát soubor</h2>
    
    <!-- Upload Bar -->
    <div class="progress-wrap">
      <div id="barUpload" class="progress-bar"></div>
      <div id="txtUpload" class="progress-txt">0%</div>
    </div>
    
    <label class="btn btn-primary" style="text-align:center; display:block; width:auto">
      Vybrat Excel (.xls / .xlsx)
      <input type="file" id="file" accept=".xlsx,.xls" style="display:none" onclick="resetUI(false)" onchange="handleFileSelect()" />
    </label>
    <div id="fileInfo" class="muted" style="text-align:center; margin-bottom:10px; min-height:20px;"></div>

    <hr style="border:0; border-top:1px solid rgba(0,0,0,0.1); margin: 20px 0;">

    <h2>2. Filtrovat data</h2>
    <div class="controls-row">
      <div>
        <label for="dateFrom">Datum od</label>
        <input type="date" id="dateFrom" />
      </div>
      <div>
        <label for="dateTo">Datum do</label>
        <input type="date" id="dateTo" />
      </div>
    </div>

    <div style="margin-top:12px">
      <label for="supplierSelect">Dodavatel</label>
      <select id="supplierSelect" disabled>
        <option value="">(Nejprve nahrajte soubor)</option>
      </select>
    </div>

    <div style="margin-top:12px">
      <label for="minRevenue">Minimální obrat (Kč)</label>
      <input type="number" id="minRevenue" min="0" step="1000" placeholder="např. 10000" />
    </div>

    <hr style="border:0; border-top:1px solid rgba(0,0,0,0.1); margin: 20px 0;">

    <div class="controls-row">
      <button class="btn btn-primary" onclick="runFilter()">Zobrazit náhled</button>
      <button class="btn btn-accent" onclick="runExport()">Stáhnout XLSX</button>
    </div>
    <div style="margin-top:10px; text-align:right;">
      <button class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;" onclick="resetUI(true)">Resetovat vše</button>
    </div>

    <!-- Process Bar -->
    <div class="status-box">
      <div id="status">Čekám na akci...</div>
      <div class="progress-wrap" id="processWrap" style="opacity:0.5; margin-bottom:0">
        <div id="barProcess" class="progress-bar"></div>
        <div id="txtProcess" class="progress-txt">0%</div>
      </div>
      <div id="error" class="error"></div>
    </div>
  </aside>

  <!-- MAIN: Výsledky -->
  <main class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2>Náhled výsledků</h2>
      <div class="muted">Zobrazuje se TOP 50 položek</div>
    </div>

    <div class="table-wrapper">
      <table id="previewTable">
        <thead>
          <tr>
            <th>Dodavatel</th>
            <th>Produkt</th>
            <th class="num">Obrat (Kč)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="3" style="text-align:center; padding:30px; color:#94a3b8">Zatím žádná data</td></tr>
        </tbody>
      </table>
    </div>

    <div id="summary" class="summary"></div>
  </main>
</div>

<!-- ===== WORKER SCRIPT ===== -->
<script>
const workerCode = `
  /* === UTIL === */
  function norm(s){ return String(s||'').toLowerCase().trim(); }
  function parseNum(val){
    if (typeof val === 'number') return val;
    if (val == null) return 0;
    let s = String(val).replace(/\\s/g, '').replace(/\\u00a0/g, '').replace(/kč/i,'');
    s = s.replace(',', '.');
    s = s.replace(/[^0-9.-]/g, '');
    const n = parseFloat(s); return isNaN(n) ? 0 : n;
  }
  function parseHeaderDate(v){
    if (v instanceof Date) return v;
    if (typeof v === 'number'){
       const d = new Date(Math.round((v - 25569) * 86400 * 1000));
       return isNaN(d.getTime()) ? null : d;
    }
    if (typeof v === 'string'){
       const parts = v.split('.');
       if(parts.length === 3){
         const day = parseInt(parts[0], 10);
         const month = parseInt(parts[1], 10) - 1; 
         const year = parseInt(parts[2], 10);
         const d = new Date(year, month, day);
         if(!isNaN(d.getTime())) return d;
       }
       const d2 = new Date(v); if(!isNaN(d2.getTime())) return d2;
    }
    return null;
  }

  function loadXLSX(cb){
    try{ importScripts('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'); cb(); }
    catch(e){ cb(e); }
  }

  self.onmessage = function(ev){
    const msg = ev.data || {};
    
    // --- SKENOVÁNÍ DODAVATELŮ ---
    if(msg.type === 'scan_suppliers'){
      const ab = msg.arrayBuffer;
      loadXLSX(function(err){
        if(err){ self.postMessage({type:'error', message:'Chyba načítání knihovny'}); return; }
        try {
          const wb = XLSX.read(ab, { type:'array', sheetRows: 0 }); // Načteme vše, ale jen data
          const suppliers = new Set();
          
          // Projdeme všechny listy (kromě Data) a vyzobeme sloupec A
          wb.SheetNames.forEach(shName => {
            if(shName.toLowerCase() === 'data') return;
            const ws = wb.Sheets[shName];
            // sheet_to_json s header:1 vrátí pole polí
            const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
            rows.forEach(r => {
              if(r && r[0]){
                const s = String(r[0]).trim();
                if(s.length > 1 && s.toLowerCase() !== 'dodavatel' && s.toLowerCase() !== 'supplier'){
                  suppliers.add(s);
                }
              }
            });
          });
          
          const sorted = Array.from(suppliers).sort();
          self.postMessage({ type:'suppliers_found', list: sorted });
          
        } catch(e){ self.postMessage({type:'error', message:e.message}); }
      });
    }

    // --- PROCES FILTRACE ---
    if(msg.type === 'process'){
      const { arrayBuffer, supplierFilter, minRevenue, wantPreview } = msg;
      const dateFrom = msg.dateFrom ? new Date(msg.dateFrom) : null;
      if(dateFrom) dateFrom.setHours(0,0,0,0);
      const dateTo = msg.dateTo ? new Date(msg.dateTo) : null;
      if(dateTo) dateTo.setHours(23,59,59,999);

      loadXLSX(function(err){
        if(err){ self.postMessage({type:'error', message:'Chyba'}); return; }
        try {
          // 1. Zjistit listy
          const wb = XLSX.read(arrayBuffer, { type:'array', cellDates:true });
          const sheetsToParse = wb.SheetNames.filter(n => n.toLowerCase() !== 'data');
          
          const agg = new Map();
          let totalIn = 0;
          let processedSheets = 0;

          // 2. Iterace listů
          for(const shName of sheetsToParse){
            processedSheets++;
            const pct = Math.round((processedSheets / sheetsToParse.length) * 100);
            self.postMessage({ type:'progress', value:pct, info:'Analyzuji: ' + shName });

            const ws = wb.Sheets[shName];
            const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
            if(!rows || rows.length < 2) continue;

            // Hlavička (řádek 0) - detekce sloupců s datem
            const header = rows[0];
            const validCols = [];
            for(let c=2; c<header.length; c++){ // od C
              const d = parseHeaderDate(header[c]);
              if(d){
                let ok = true;
                if(dateFrom && d < dateFrom) ok = false;
                if(dateTo && d > dateTo) ok = false;
                if(ok) validCols.push(c);
              }
            }
            if(validCols.length === 0 && (dateFrom || dateTo)) continue; // List nemá relevantní data

            // Data (řádek 1+)
            let currSupp = null;
            for(let r=1; r<rows.length; r++){
              const row = rows[r]; if(!row) continue;
              const valA = row[0];
              const valB = row[1];

              // A = Dodavatel
              if(valA && String(valA).trim()){
                const s = String(valA).trim();
                if(s.toLowerCase()!=='dodavatel') currSupp = s;
              }

              // B = Produkt
              if(valB && currSupp){
                const prod = String(valB).trim();
                // IGNOROVAT "SL"
                if(prod.toUpperCase().startsWith('SL')) continue;
                if(prod.toLowerCase()==='produkt') continue;

                // Filtr dodavatele (Dropdown)
                if(supplierFilter && currSupp !== supplierFilter) continue;

                // Součet
                let sum = 0;
                // Pokud nemáme filtr data, bereme všechny sloupce od 2
                const cols = (validCols.length > 0) ? validCols : Array.from({length: row.length-2}, (_,i)=>i+2);
                
                for(let c of cols){
                  const v = row[c];
                  if(v) sum += parseNum(v);
                }

                if(sum !== 0){
                  totalIn++;
                  const key = currSupp + '|||' + prod;
                  const exist = agg.get(key);
                  if(exist) exist.sum += sum;
                  else agg.set(key, { s:currSupp, p:prod, sum:sum });
                }
              }
            }
          }

          // 3. Výsledky & Min. obrat
          let res = Array.from(agg.values());
          if(minRevenue > 0) res = res.filter(x => x.sum >= minRevenue);
          res.sort((a,b) => b.sum - a.sum);

          // Export
          let xlsxBuff = null, fName = null;
          if(!wantPreview){
            const aoa = [['Dodavatel','Produkt','Obrat']].concat(res.map(x => [x.s, x.p, x.sum]));
            const newWs = XLSX.utils.aoa_to_sheet(aoa);
            // Format cisel
            for(let r=1; r<aoa.length; r++){
               const ref = XLSX.utils.encode_cell({r:r, c:2});
               if(newWs[ref]) newWs[ref].z = '#,##0.00';
            }
            const newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newWs, 'Export');
            xlsxBuff = XLSX.write(newWb, { bookType:'xlsx', type:'array' });
            fName = 'Export_kampan.xlsx';
          }

          self.postMessage({
            type: wantPreview ? 'preview' : 'export',
            data: res.slice(0, 50),
            stats: { totalIn, out: res.length, sheetCount: sheetsToParse.length },
            file: { buff: xlsxBuff, name: fName }
          });

        } catch(e){ self.postMessage({type:'error', message:e.message}); }
      });
    }
  };
`;

const blob = new Blob([workerCode], {type:'application/javascript'});
const worker = new Worker(URL.createObjectURL(blob));

/* === UI === */
const el = id => document.getElementById(id);
let lastBuffer = null;

// Worker Listeners
worker.onmessage = e => {
  const m = e.data;
  if(m.type === 'error'){
    el('error').textContent = 'Chyba: ' + m.message;
    el('status').textContent = 'Chyba procesu.';
    setProcess(0, 'error');
  }
  else if(m.type === 'suppliers_found'){
    // Naplnění dropdownu
    const sel = el('supplierSelect');
    sel.innerHTML = '<option value="">-- Všichni dodavatelé --</option>';
    m.list.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });
    sel.disabled = false;
    el('status').textContent = 'Soubor analyzován. Vyberte filtry.';
    setUpload(100); // Hotovo
  }
  else if(m.type === 'progress'){
    setProcess(m.value);
    el('status').textContent = m.info;
  }
  else if(m.type === 'preview' || m.type === 'export'){
    setProcess(100, 'success');
    el('status').textContent = 'Hotovo.';
    renderTable(m.data);
    el('summary').innerHTML = 
      '<div class="tag">Listů: '+m.stats.sheetCount+'</div>' +
      '<div class="tag">Položek: '+fmt(m.stats.totalIn)+'</div>' +
      '<div class="tag">Výsledek: '+fmt(m.stats.out)+'</div>';
    
    if(m.type === 'export') download(m.file.buff, m.file.name);
  }
};

function handleFileSelect(){
  const f = el('file').files[0];
  if(!f) return;
  
  // UI Reset
  el('error').textContent = '';
  el('previewTable').getElementsByTagName('tbody')[0].innerHTML = '<tr><td colspan="3" style="text-align:center;padding:30px">Čekám na filtraci...</td></tr>';
  el('summary').innerHTML = '';
  el('supplierSelect').innerHTML = '<option>Načítám...</option>';
  el('supplierSelect').disabled = true;
  el('processWrap').style.opacity = '0.5';
  el('barProcess').style.width = '0%';
  
  el('fileInfo').textContent = f.name + ' (' + (f.size/1024/1024).toFixed(1) + ' MB)';
  el('status').textContent = 'Nahrávám a skenuji dodavatele...';

  // Read File
  const reader = new FileReader();
  reader.onprogress = e => {
    if(e.lengthComputable) setUpload((e.loaded/e.total)*90); // 90% upload, 10% scan
  };
  reader.onload = e => {
    lastBuffer = e.target.result;
    setUpload(95);
    // Spustit scan dodavatelů
    worker.postMessage({ type:'scan_suppliers', arrayBuffer: lastBuffer });
  };
  reader.readAsArrayBuffer(f);
}

function runFilter(){ startProcess(true); }
function runExport(){ startProcess(false); }

function startProcess(preview){
  if(!lastBuffer) { el('error').textContent = 'Nejprve nahrajte soubor.'; return; }
  el('error').textContent = '';
  el('status').textContent = 'Zpracovávám data...';
  el('processWrap').style.opacity = '1';
  el('barProcess').classList.remove('success');
  
  worker.postMessage({
    type: 'process',
    arrayBuffer: lastBuffer,
    wantPreview: preview,
    dateFrom: el('dateFrom').value,
    dateTo: el('dateTo').value,
    minRevenue: parseFloat(el('minRevenue').value || 0),
    supplierFilter: el('supplierSelect').value
  });
}

function renderTable(data){
  const tbody = el('previewTable').getElementsByTagName('tbody')[0];
  if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px">Žádná data neodpovídají filtru.</td></tr>'; return; }
  
  let html = '';
  data.forEach(r => {
    html += '<tr><td>'+esc(r.s)+'</td><td>'+esc(r.p)+'</td><td class="num">'+fmtMoney(r.sum)+'</td></tr>';
  });
  tbody.innerHTML = html;
}

function download(buff, name){
  const url = URL.createObjectURL(new Blob([buff], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  const a = document.createElement('a'); a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function setUpload(p){
  el('barUpload').style.width = p + '%';
  el('txtUpload').textContent = Math.round(p) + '%';
}
function setProcess(p, state){
  const bar = el('barProcess');
  bar.style.width = p + '%';
  el('txtProcess').textContent = Math.round(p) + '%';
  if(state === 'success') bar.classList.add('success');
  else bar.classList.remove('success');
}
function resetUI(full){
  if(full){
    el('file').value = ''; lastBuffer = null;
    setUpload(0); el('fileInfo').textContent = '';
    el('supplierSelect').innerHTML = '<option value="">(Nejprve nahrajte soubor)</option>';
    el('supplierSelect').disabled = true;
  }
  el('previewTable').getElementsByTagName('tbody')[0].innerHTML = '<tr><td colspan="3" style="text-align:center;padding:30px">Zatím žádná data</td></tr>';
  el('summary').innerHTML = '';
  el('error').textContent = '';
  el('status').textContent = 'Stav: připraveno';
  el('processWrap').style.opacity = '0.5';
  el('barProcess').style.width = '0%';
}
function fmt(n){ return new Intl.NumberFormat('cs-CZ').format(n); }
function fmtMoney(n){ return new Intl.NumberFormat('cs-CZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
</script>
</body>
</html>
